<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/app-route/app-location.html">
<link rel="import" href="bower_components/app-route/app-route.html">
<link rel="import" href="bower_components/iron-icons/social-icons.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">

<link rel="import" href="rr-hot-page.html">
<link rel="import" href="rr-top-page.html">
<link rel="import" href="rr-favorites-page.html">
<link rel="import" href="rr-login-page.html">

<dom-module id="reddit-reader">
  <template>
  <style>
  app-header {
    background-color: #4285f4;
    color: #fff;
  }

  app-drawer {
    --app-drawer-content-container: {
      background-color: #d6d6d6;
    };
  }

  paper-menu {
    background-color: #d6d6d6;
  }

  .fullbleed > * {
    position: absolute;
    top: 64px;
    bottom: 0;
    left: 0;
    right: 0;
  }
  </style>
  <app-location route="{{route}}" use-hash-as-path></app-location>
  <app-route route="{{route}}" pattern="/:view" data="{{routeData}}" tail="{{subroute}}"></app-route>
  <firebase-auth app-name="redditReader" id="auth" user="{{user}}" provider="google" signed-in="{{signedIn}}">
  </firebase-auth>
  <app-header-layout fullbleed>
    <app-header fixed>
      <app-toolbar>
        <div main-title>Reddit Reader App</div>
        <paper-tabs selected="{{routeData.view}}" attr-for-selected="tab">
          <paper-tab tab="hot">
            <iron-icon icon="social:whatshot" item-icon></iron-icon>
            Hot
          </paper-tab>
          <paper-tab tab="top">
            <iron-icon icon="thumb-up" item-icon></iron-icon>
            Top
          </paper-tab>
          <paper-tab tab="favorites">
            <iron-icon icon="star" item-icon></iron-icon>
            Favorites
          </paper-tab>
        </paper-tabs>
        <paper-button raised hidden="[[!signedIn]]" on-tap="signout">logout</paper-button>
        <paper-button raised hidden="[[signedIn]]" on-tap="goToLogin">login</paper-button>
      </app-toolbar>
    </app-header>

    <!-- main content -->
    <div class="fullbleed">
      <template is="dom-if" if="[[isRightPage(routeData.view, 'login')]]">
        <rr-login-page on-sign-in="login"></rr-login-page>
      </template>
      <template is="dom-if" if="[[isRightPage(routeData.view, 'hot')]]">
        <rr-hot-page></rr-hot-page>
      </template>
      <template is="dom-if" if="[[isRightPage(routeData.view, 'top')]]">
        <rr-top-page></rr-top-page>
      </template>
      <template is="dom-if" if="[[isRightPage(routeData.view, 'favorites')]]">
        <rr-favorites-page></rr-favorites-page>
      </template>
    </div>
  </app-header-layout>
</template>
<script>
Polymer({
  is: 'reddit-reader',

  properties: {
    signedIn: {
      type: Boolean,
      observer: '_onSignedInChanged',
    },
  },

  observers: ['_onPathChange(route.path)'],

  _previousPage: null,

  _onPathChange(path) {
    if (!path) {
      this.navigateTo('/hot');
    }
    if (path === '/favorites' && !this.signedIn) {
      this.goToLogin();
    }
  },

  _onSignedInChanged(signedIn) {
    if (signedIn) {
      if (this.routeData.view === 'login') {
        if (this._previousPage) {
          this.navigateTo('/' + this._previousPage);
          this._previousPage = null;
        } else {
          this.navigateTo('/hot');
        }
      }
    } else {
      this.navigateTo('/login');
    }
  },

  goToLogin() {
    if (this.routeData.view !== 'login') {
      this._previousPage = this.routeData.view;
      this.navigateTo('/login');
    }
  },

  login() {
    this.$.auth.signInWithPopup().then(() => {
    });
  },

  signout() {
    this.$.auth.signOut().then(() => {
    });
  },

  navigateTo(path) {
    this.async(() => {
      this.set('route.path', path);
    });
  },

  isRightPage(view, name) {
    return view === name;
  },
});
</script>
</dom-module>
