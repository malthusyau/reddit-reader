<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-card/paper-card.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/iron-image/iron-image.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="rr-post">
  <template>
  <style include="iron-flex">
  :host[previewable] paper-card {
    cursor: pointer;
  }

  paper-card {
    display: block;
    margin: 16px 0;
    position: relative;
  }

  img {
    height: 120px;
  }

  img:not([src^='http']) {
    display: none;
  }

  .content {
    margin: 10px 40px 10px 10px;
  }

  paper-card:hover .star {
    display: block;
  }

  :host[saved] .star {
    display: block;
    color: #ffcb2c;
  }

  .star {
    display: none;
    position: absolute;
    top: 0;
    right: 0;
  }

  .source {
    font-size: 12px;
    color: #bbbbbb;
  }

  .title {
    color: #2b2b2b;
    text-decoration: none;
  }

  .title:visited {
    color: #6b47ad;
  }
  </style>
  <paper-card on-tap="openPreview">
    <div class="layout horizontal">
      <img src="[[getThumbnail(data.thumbnail)]]"></img>
      <div class="flex content">
        <a href$="[[decodeHtml(data.url)]]" class="title" target="_blank" onclick="event.stopPropagation();">[[decodeHtml(data.title)]]</a>
        <span class="source">([[data.domain]])</span>
        <br>
        <a href$="https://reddit.com[[data.permalink]]" class="comments" onclick="event.stopPropagation();">[[data.num_comments]] comments</a>
      </div>
    </div>
    <paper-icon-button class="star" icon="[[getStarIcon(saved)]]" on-tap="toggleFavorite"></paper-icon-button>
  </paper-card>
</template>
<script>
Polymer({
  is: 'rr-post',

  properties: {
    data: Object,
    saved: {
      type: Boolean,
      reflectToAttribute: true,
      value: false,
    },
    previewable: {
      type: Boolean,
      reflectToAttribute: true,
      computed: 'hasPreview(data)',
    },
  },

  decodeHtml(html) {
    var txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
  },

  getThumbnail(url) {
    if (!!url && url.indexOf('http') === 0) {
      return url;
    }
    return '';
  },

  getStarIcon(saved) {
    return saved ? 'star' : 'star-border';
  },

  hasPreview(data) {
    return !!data.preview;
  },

  openPreview() {
    if (this.previewable) {
      this.fire('open-preview', {data: this.data});
    }
  },

  toggleFavorite(event) {
    event.stopPropagation();
    if (!this.saved) {
      this.fire('save', {id: this.data.name, cb: () => {this.saved = true;}});
    } else {
      this.fire('delete', {id: this.data.name, cb: () => {this.saved = false;}});
    }
  },
});
</script>
</dom-module>
